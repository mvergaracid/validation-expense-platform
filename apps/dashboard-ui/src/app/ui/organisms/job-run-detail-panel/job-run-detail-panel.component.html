<div>
  @if (!detail) {
    <div class="p-4 text-sm text-text-muted">{{ emptyText }}</div>
  }

  @if (detail) {
    <div class="p-4">
      <div class="text-sm font-medium">{{ detail!.run.job_id }}</div>
      <div class="mt-1 text-xs text-text-muted">
        {{ detail!.run.pattern }} Â· {{ detail!.run.status }}
      </div>

      @if (detail!.run.expense_id || detail!.run.meta) {
        <div class="mt-4">
          <div class="text-xs tracking-[0.3em] text-text-muted">GASTO</div>
          <div class="mt-3 rounded-lg border border-border p-3 text-xs text-text-muted">
            @if (detail!.run.expense_id) {
              <div>id: {{ detail!.run.expense_id }}</div>
            }
            @if (detail!.run.meta?.['empleado_id']) {
              <div>empleado_id: {{ detail!.run.meta!['empleado_id'] }}</div>
            }
            @if (detail!.run.meta?.['fecha']) {
              <div>fecha: {{ detail!.run.meta!['fecha'] }}</div>
            }
            @if (detail!.run.meta?.['monto_original']) {
              <div>
                monto_original: {{ detail!.run.meta!['monto_original'] }}
                @if (detail!.run.meta?.['moneda_original']) {
                  {{ detail!.run.meta!['moneda_original'] }}
                }
              </div>
            }
            @if (detail!.run.meta?.['categoria']) {
              <div>categoria: {{ detail!.run.meta!['categoria'] }}</div>
            }
            @if (detail!.run.meta?.['cost_center']) {
              <div>cost_center: {{ detail!.run.meta!['cost_center'] }}</div>
            }
            @if (detail!.run.meta?.['csv_row']) {
              <div class="mt-3">csv_row:</div>
              <pre class="mt-2 overflow-auto rounded-md bg-bg px-3 py-2 text-xs">{{ detail!.run.meta!['csv_row'] | json }}</pre>
            }
          </div>
        </div>
      }

      @if (detail!.run.meta?.['processId']) {
        <div class="mt-4">
          <div class="text-xs tracking-[0.3em] text-text-muted">PROCESO</div>
          <div class="mt-3 rounded-lg border border-border p-3 text-xs text-text-muted">
            <div>processId: {{ detail!.run.meta!['processId'] }}</div>
            @if (detail!.run.meta?.['batchIndex'] !== undefined) {
              <div>batchIndex: {{ detail!.run.meta!['batchIndex'] }}</div>
            }
            @if (detail!.run.meta?.['recordIndex'] !== undefined) {
              <div>recordIndex: {{ detail!.run.meta!['recordIndex'] }}</div>
            }
          </div>
        </div>
      }

      @if (detail!.run.meta?.['dedup']) {
        <div class="mt-4">
          <div class="text-xs tracking-[0.3em] text-text-muted">DEDUP</div>
          <div class="mt-3 rounded-lg border border-border p-3 text-xs text-text-muted">
            <pre class="overflow-auto rounded-md bg-bg px-3 py-2 text-xs">{{ detail!.run.meta!['dedup'] | json }}</pre>
          </div>
        </div>
      }

      @if (detail!.run.meta?.['validation']) {
        <div class="mt-4">
          <div class="text-xs tracking-[0.3em] text-text-muted">VALIDATION (META)</div>
          <div class="mt-3 rounded-lg border border-border p-3 text-xs text-text-muted">
            <pre class="overflow-auto rounded-md bg-bg px-3 py-2 text-xs">{{ detail!.run.meta!['validation'] | json }}</pre>
          </div>
        </div>
      }

      <div class="mt-4">
        <div class="text-xs tracking-[0.3em] text-text-muted">STAGES</div>
        <div class="mt-3 space-y-2">
          @for (stage of detail!.stages; track stage.id) {
            <div class="rounded-lg border border-border p-3">
              <div class="flex items-center justify-between">
                <div class="text-sm font-medium">{{ stage.stage }}</div>
                <div class="text-xs">
                  <span class="rounded-full border border-border px-2 py-1">{{ stage.status }}</span>
                </div>
              </div>
              @if (stage.stage === 'currency' && stage.data?.['rate_source']) {
                <div class="mt-2 text-xs text-text-muted">rate_source: {{ stage.data!['rate_source'] }}</div>
              }
              @if (stage.stage === 'validation') {
                @let alertas = getAlertas(stage);
                <div class="mt-2 text-xs text-text-muted">
                  @if (alertas.length === 0) {
                    Sin alertas
                  } @else {
                    Alertas:
                    <ul class="list-disc ml-4 mt-1 space-y-1">
                      @for (alerta of alertas; track alerta?.codigo ?? $index) {
                        <li>
                          <span class="font-medium">{{ alerta?.codigo ?? 'N/A' }}</span>
                          <span>- {{ alerta?.mensaje ?? (alerta | json) }}</span>
                        </li>
                      }
                    </ul>
                  }
                </div>
              }
              @if (stage.error) {
                <div class="mt-2 text-xs text-danger">{{ stage.error }}</div>
              }
              @if (stage.data) {
                <pre class="mt-2 overflow-auto rounded-md bg-bg px-3 py-2 text-xs">{{ stage.data | json }}</pre>
              }
            </div>
          }
        </div>
      </div>
    </div>
  }
</div>
